services:
  # FastAPI web service
  - type: web
    name: grammar-heroes-api
    env: docker
    dockerfilePath: ./Dockerfile
    autoDeploy: true
    healthCheckPath: /healthz
    startCommand: >
      gunicorn -k uvicorn.workers.UvicornWorker -w 2
      -b 0.0.0.0:$PORT app.main:app
    preDeployCommand: alembic upgrade head
    envVars:
      - key: DATABASE_URL
        sync: false
      - key: DATABASE_URL_SYNC
        sync: false
      - key: REDIS_URL
        value: redis://redis:6379
      - key: DEBUG
        value: "false"
      - key: SAPLING_API_KEY
        sync: false
      - key: FIREBASE_CREDENTIALS
        value: /etc/secrets/firebase_sa.json
    secrets:
      - name: firebase_sa.json

  # Redis worker
  - type: worker
    name: redis
    env: docker
    dockerCommand: redis-server --appendonly yes
    buildCommand: ""
    dockerfilePath: ""
    autoDeploy: false
    image:
      url: redis:7-alpine
    disk:
      name: redis-data
      mountPath: /data
      sizeGB: 1